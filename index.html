<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style type="text/css">
		body{
			padding: 0;
			margin: 1%;
		}
		#ball, #bball{
			cursor: pointer;
		}
		#svg, #svg2, #svg3{
			border: 1px solid #ccc;
			width: 48%;
			height: 400px;
		}
		#svg text{
			cursor: pointer;
		}
	</style>
	
</head>
<body>
	<div><span id="sum">1000</span> руб.</div> 
	<svg id="svg"></svg> 
	<svg id="svg2"></svg> 
	<svg id="svg3"></svg> 
	<script src="/js/snap.svg-min.js"></script>
	<script src="/js/snaptut-freetransform.js"></script>
	<script type="text/javascript">
		var _sum = 1000;
		var _trStep = 50;
		window.onload = function() {
			var s = Snap("#svg");
			var s2 = Snap("#svg2");
			var s3 = Snap("#svg3");
			var g = s.group();
			var g2 = s2.group();
			var g3 = s3.group();
			var clink = s.text(600, 50, "Клонировать");
			
			//third window
			Snap.load("svg/ball_v1.svg", function(f){
				g3.append(f);
				//var ball = g3.select("#path1587");
        		g3.click( function() {
					changePrice(50);
					_trStep+=50;
					var nb = this.clone().transform( 't'+_trStep+','+_trStep).drag();
					//console.log(nb.select("path"));
					//nb.select("path").attr('fill', "url(#id"+getRandomInt(2,270)+")");
				} );
				g3.drag();
			});

			//second window
			Snap.load("svg/arka.svg", function(f){
				
				g2.append(f);
        		g2.ftCreateHandles();
			});
			
			Snap.load("svg/arka.svg", function(f) {

				
				//first window
    			var grln = g.append(f);
    			
				function addHandleFunc() {
					var dragging = 0;
					var handleGroup;
					var obj = this;

					var start = function() {
				        obj.data('origTransform', obj.transform().local);
					}

					var move = function(dx,dy) {
				        var scale = 1 + dx / 50;
				        obj.attr({
				            transform: obj.data('origTransform') + (obj.data('origTransform') ? "S" : "s") + scale
				        });
					}

					var stop = function() {
						//dragging = 0;
		                s.append(obj);
		                handleGroup.selectAll('handler').remove();
		                handleGroup.remove();
					};

			        if( dragging == 0 ) {
		                dragging = 1;
		                var bb = this.getBBox();
		                var handle = new Array();
		                handle[0] = s.circle(bb.x,bb.y,10).attr({class: 'handler'});;
		                handle[1] = s.circle(bb.x+bb.width, bb.y, 10).attr({class: 'handler'});
		                handleGroup = s.group(this, handle[0], handle[1]);
		                handleGroup.drag(move,start,stop);
			        } else {
		                dragging = 0;
		                s.append(this);
		                handleGroup.selectAll('handler').remove();
		                handleGroup.remove();
			        }
				}





				grln.dblclick( addHandleFunc );

				//clone
				var trStep = 50;
				clink.click(function(){
					changePrice(1000);
					trStep+=50;
					grln.clone().transform( 't'+trStep+','+trStep).dblclick( addHandleFunc ).drag();
				});
    			
    			grln.drag();
			});
		
			function addHandleFunc(obj) {
				var dragging = 0;
				var handleGroup;
				var start = function() {
				        this.data('origTransform', this.transform().local);
				}

				var move = function(dx,dy) {
				        var scale = 1 + dx / 50;
				        this.attr({
				                transform: this.data('origTransform') + (this.data('origTransform') ? "S" : "s") + scale
				        });
				}

				var stop = function() {};
		        if( dragging == 0 ) {
		                dragging = 1;
		                var bb = obj.getBBox();
		                var handle = new Array();
		                handle[0] = s.circle(bb.x,bb.y,10).attr({class: 'handler'});;
		                handle[1] = s.circle(bb.x+bb.width, bb.y, 10).attr({class: 'handler'});
		                handleGroup = s.group(obj, handle[0], handle[1]);
		                handleGroup.drag(move,start,stop);
		        } else {
		                dragging = 0;
		                s.append(obj);
		                handleGroup.selectAll('handler').remove();
		                handleGroup.remove();
		        }
			}

			function changePrice(amount){
				var sumTarget = document.getElementById("sum");
				sumTarget.innerHTML = parseInt(sumTarget.innerHTML) + amount;
			}
		
			function getRandomInt(min, max) {
			    return Math.floor(Math.random() * (max - min + 1)) + min;
			}

			function toggleColor(c1, c2){
				if(flag == true){
					ball.fill(c1);
			      flag = false;
			    }else{
					ball.fill(c2);
			      flag = true;
			    }
			}
		}
		
	</script>
</body>
</html>